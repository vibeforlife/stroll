<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Oʻahu Walking Guide</title>
<link href="icons/icon-192.png" rel="icon"/>
<!-- Leaflet (online) -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>:root{
  --bg:#0F172A;
  --text:#e8eefc;
  --muted:#a9b7d6;
  --accent:#7dd3fc;
  --accent2:#a78bfa;
  --border:rgba(255,255,255,.12);
  --shadow:0 18px 44px rgba(0,0,0,.35);
  --radius:18px;
  --radius2:14px;
  --chip:rgba(125,211,252,.14);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1100px 600px at 20% 0%, rgba(125,211,252,.14), transparent 55%),
             radial-gradient(900px 700px at 80% 25%, rgba(167,139,250,.14), transparent 60%),
             var(--bg);
  color:var(--text);
  font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  line-height:1.35;
}
header{
  position:sticky; top:0;
  padding:16px 18px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:flex-start;
  gap:12px;
  border-bottom:1px solid var(--border);
  background:rgba(11,18,32,.72);
  backdrop-filter:blur(10px);
  z-index:50;
}
.brand{display:flex;align-items:center;gap:12px}
.dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 5px rgba(125,211,252,.12)}
h1{font-size:16px;margin:0}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.top-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;justify-content:flex-start;width:100%}
.pill,.select{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--border);
  background:rgba(18,31,56,.55);
  border-radius:999px;
  padding:8px 12px;
  color:var(--text);
  font-size:12px;
  box-shadow:var(--shadow);
  user-select:none;
}
select{background:transparent;color:var(--text);border:none;outline:none;font-size:12px;max-width:260px}
button{
  border:none;
  border-radius:14px;
  padding:10px 12px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#06121f;
  font-weight:800;
  cursor:pointer;
  box-shadow:var(--shadow);
}
button.secondary{
  background:rgba(18,31,56,.75);
  color:var(--text);
  border:1px solid var(--border);
  font-weight:700;
}
button.danger{
  background:rgba(239,68,68,.18);
  color:#ffe9e9;
  border:1px solid rgba(239,68,68,.35);
}
button:disabled{opacity:.55;cursor:not-allowed}
.hidden{display:none !important}
.view-toggle{display:flex;gap:8px}
.view-toggle button{border-radius:999px;padding:8px 12px;position:relative}
.view-toggle button.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#06121f;border:none;font-weight:800}
.view-toggle button.active::after{content:"";position:absolute;left:12px;right:12px;bottom:5px;height:2px;border-radius:2px;background:rgba(6,18,31,.35)}
.wrap{max-width:980px;margin:0 auto;padding:14px}
.panel{margin-bottom:14px}
.card{
  background:rgba(18,31,56,.55);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--shadow);
}
.title{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.title h2{margin:0;font-size:14px}
.small{color:var(--muted);font-size:12px;margin-top:6px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.now{margin-top:12px;border-top:1px dashed rgba(255,255,255,.16);padding-top:12px}
.now-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
.status{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
.pulse{width:10px;height:10px;border-radius:999px;background:rgba(125,211,252,.9);box-shadow:0 0 0 0 rgba(125,211,252,.7);animation:pulse 1.6s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(125,211,252,.55)}70%{box-shadow:0 0 0 10px rgba(125,211,252,0)}100%{box-shadow:0 0 0 0 rgba(125,211,252,0)}}
.content{font-size:14px;color:rgba(248,250,252,.92);margin-top:8px}
.meta{color:var(--muted);font-size:12px;margin-top:8px}
.stop-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.stop{
  border:1px solid var(--border);
  border-radius:var(--radius2);
  padding:12px;
  cursor:pointer;
  background:rgba(0,0,0,.14);
  transition:transform .08s ease,border-color .08s ease,background .08s ease;
}
.stop:hover{transform:translateY(-1px);border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.06)}
.stop.active{border-color:rgba(125,211,252,.55);background:rgba(125,211,252,.08)}
.stop .name{font-weight:800}
.stop .subline{font-size:12px;color:var(--muted);margin-top:6px}
#mapWrap{position:relative}
#map{
  width:100%;
  height:calc((var(--vh, 1vh) * 100) - 62px - 28px);
  min-height:520px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
#offlineMapWrap{
  position:absolute;
  inset:12px;
  display:none;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:rgba(3,7,18,.72);
  backdrop-filter:blur(10px);
  overflow:hidden;
}
#offlineMapWrap.open{display:block}
.offlineBadge{
  position:absolute; top:12px; left:12px;
  background:rgba(18,31,56,.8);
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 12px;
  font-size:12px;
  color:var(--text);
}
#offlineMapSvg{width:100%;height:100%}

/* Modal */
.modal-backdrop{pointer-events:auto;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:120;
  padding:18px;
}
.modal-backdrop.open{display:flex}
.modal{
  width:min(680px,100%);
  max-height:min(82vh,720px);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  border:1px solid var(--border);
  background:rgba(18,31,56,.92);
  border-radius:22px;
  box-shadow:var(--shadow);
  padding:16px;
}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.field{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(0,0,0,.12)}
.label{font-size:12px;color:var(--muted);margin-bottom:8px}
.modal h2{margin:0;font-size:16px}
@media (max-width: 720px){
  .grid{grid-template-columns:1fr}
  #map{min-height:380px;height:60vh}
}

/* Arrival / completion / memories overlays (legacy) */
.arrivalCard{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:130;
  padding:18px;
  background:rgba(0,0,0,.55);
}
.arrivalCard.show, .arrivalCard.open{display:flex}
.arrivalInner{
  width:min(760px,100%);
  border:1px solid var(--border);
  background:rgba(18,31,56,.92);
  border-radius:22px;
  box-shadow:var(--shadow);
  padding:16px;
  max-height:min(82vh,720px);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.subtle{color:var(--muted);font-size:12px}
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:rgba(18,31,56,.9);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 12px;
  border-radius:999px;
  box-shadow:var(--shadow);
  z-index:200;
  display:none;
  max-width:calc(100% - 24px);
  font-size:12px;
}
.toast.show{display:block}


body.modalOpen{overflow:hidden;}

#btnCloseSettings{position:relative;z-index:2;}

button{touch-action:manipulation}
</style>
</head>
<body>
<header>
<div class="brand">
<div class="dot"></div>
<div>
<h1 style="font-weight:700;letter-spacing:.3px">Stroll Walking Guide</h1>
<div class="sub">Every place has a story</div>
</div>
</div>
<div class="top-actions" style="flex-direction:column;align-items:flex-start;gap:10px">
<div class="select"><span>City</span>
<input id="citySearch" list="cityList" placeholder="Search city…" style="min-width:160px"/>
<datalist id="cityList"></datalist>
</div>
<div class="select"><span>Tour</span><select id="routeSelect"></select></div>
<button class="secondary" id="btnSettings" style="border-radius:999px;padding:8px 12px">⚙️ Settings</button><div class="view-toggle"><button class="secondary" id="btnViewStops">Stops</button><button class="secondary" id="btnViewMap">Map</button></div>
</div>
</header>
<div class="wrap"><section class="panel" data-view="stops" id="panelStops"><aside>
<div class="card">
<div class="title">
<div>
<h2 id="routeTitle">Loading…</h2>
<div class="small" id="routeDesc"></div>
</div>
<div class="pill" id="distancePill">~— km</div>
</div>
<div class="row">
<div class="pill"><input id="foodOnly" style="transform: translateY(1px)" type="checkbox"/> <label for="foodOnly" style="cursor:pointer">cheap-eats stops only</label></div>
</div>
<div class="controls">
<button class="secondary" id="btnPrev">◀ Prev</button>
<button class="secondary" id="btnStartTour" title="Start tour: unlock audio + enable Walk Mode">Start Tour</button>
<button class="secondary" id="btnSaveMoment" title="Save this stop to Memories">★ Save moment</button>
<button id="btnPlay">▶ Play</button>
<button class="secondary" disabled="" id="btnPause">⏸ Pause</button>
<button class="danger" disabled="" id="btnStop">⏹ Stop</button>
<button class="secondary" id="btnNext">Next ▶</button>
</div>
<div class="now">
<div class="now-title">
<strong id="nowTitle">Select a stop</strong>
<div class="status"><span class="pulse" id="pulse"></span><span id="nowStatus">Idle</span></div>
</div>
<div class="content" id="nowText">Pick a stop. I’ll do the talking — you do the strolling.</div>
<div class="meta" id="etaHint"></div>
</div>
<div class="stop-list" id="stopList"></div>
</div>
</aside></section><section class="panel" data-view="map" id="panelMap"><main><div id="mapWrap" style="position:relative">
<div id="map"></div>
<div aria-hidden="true" id="offlineMapWrap">
<div class="offlineBadge">Offline map • ETA</div>
<svg id="offlineMapSvg" preserveaspectratio="xMidYMid meet" viewbox="0 0 1000 650"></svg>
</div>
</div></main></section></div>
<script src="./app.js"></script>
<script>
  // Mobile viewport height fix (iOS Safari + Android Chrome address bar behavior)
  function setVh(){
    document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
  }
  window.addEventListener('resize', setVh);
  setVh();
</script>
<script>
  // Offline support (UI + routes + scripts). Map tiles still require internet.
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./sw.js");
      } catch (e) {}
    });

    // If the new SW takes control after refresh, reflect it
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      const el = document.getElementById("offlineReadyPill");
      if (el) el.textContent = "offline: ready ✓";
    });
  }
</script>
<!-- Settings Modal -->
<div aria-hidden="true" class="modal-backdrop" id="settingsBackdrop">
<div aria-labelledby="settingsTitle" aria-modal="true" class="modal" role="dialog">
<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
<h2 id="settingsTitle">Settings</h2>
<button class="secondary" id="btnCloseSettings" aria-label="Close settings" style="border-radius:999px;padding:8px 12px">✕</button>
</div>
<div class="grid">
<div class="field">
<div class="label">Audio</div>
<select id="audioMode">
<option selected="" value="tts">TTS only</option>
<option value="auto">Auto (Pack → TTS)</option>
<option hidden="" value="pack">Offline Pack only</option>
</select>
<div class="small" style="margin-top:8px">Tip: phones usually require you to tap Play before audio starts.</div>
</div>
<div class="field">
<div class="label">Voice (default: Samantha en-US if available)</div>
<select id="voiceSelect"></select>
<div class="small" style="margin-top:8px">If Samantha isn’t available (common on Android), we’ll pick the first English voice.</div>
</div>
<div class="field">
<div class="label">Speed</div>
<select id="rateSelect">
<option value="0.9">0.9×</option><option selected="" value="1.0">1.0×</option><option value="1.1">1.1×</option><option value="1.2">1.2×</option>
</select>
</div>
<div class="field">
<div class="label">Offline status</div>
<div class="pill" id="offlineReadyPill" style="box-shadow:none;margin-bottom:10px">offline: preparing…</div>
<div class="pill" id="offlinePill" style="box-shadow:none">offline pack: checking…</div>
<div class="small" style="margin-top:10px">UI + routes + scripts are cached for offline after first load. Map tiles still need internet.</div>
</div>
</div>
<div class="field">
<div class="label">Offline packs</div>
<div class="small" style="margin-bottom:10px">Download the selected tour so routes + narration work with no signal. (Map tiles still need internet.)</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<button id="btnDownloadTour">Download this tour</button>
<button class="secondary" id="btnRemoveTour">Remove offline copy</button>
<span class="pill" id="packPill" style="box-shadow:none">pack: none</span>
</div>
<div class="small" id="packProgress" style="margin-top:10px"></div>
</div>
<div class="field">
<div class="label">Walk Mode</div>
<div class="small" style="margin-bottom:10px">Auto-advance and play when you get close to the next stop.</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<select id="walkRadius">
<option value="40">40 m</option>
<option selected="" value="60">60 m</option>
<option value="90">90 m</option>
<option value="120">120 m</option>
</select>
<select id="walkTarget">
<option selected="" value="next">Trigger next stop</option>
<option value="current">Trigger current stop</option>
</select>
<select id="walkSpeed">
<option value="1.1">Slow</option>
<option selected="" value="1.4">Normal</option>
<option value="1.7">Fast</option>
</select>
<select id="offRouteThreshold">
<option value="60">Off-route: 60 m</option>
<option selected="" value="90">Off-route: 90 m</option>
<option value="130">Off-route: 130 m</option>
</select>
<select id="walkCooldown">
<option value="20">20 s cooldown</option>
<option selected="" value="35">35 s cooldown</option>
<option value="60">60 s cooldown</option>
</select>
</div>
<div class="pill" style="box-shadow:none;margin-top:10px"><input id="batterySaver" style="transform: translateY(1px)" type="checkbox"/> <label for="batterySaver" style="cursor:pointer">battery saver (less GPS)</label></div>
<div class="small" style="margin-top:10px">Tip: on mobile, tap Play once to “unlock” audio.</div>
</div>
<div class="footer">
<div class="field" style="flex:1">
<div class="label">Keyboard shortcuts (desktop)</div>
<div class="kbdpill">
<span class="kbdchip">J</span> prev
          <span class="kbdchip">K</span> next
          <span class="kbdchip">Space</span> play/pause
          <span class="kbdchip">S</span> stop
        </div>
</div>
<div class="field">
<div class="label">Ambient sound</div>
<div class="small" style="margin-bottom:10px">Subtle background ambience. Defaults to very low volume.</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<div class="pill" style="box-shadow:none">
<input checked="" id="ambientOn" style="transform: translateY(1px)" type="checkbox"/>
<label for="ambientOn" style="cursor:pointer">on</label>
</div>
<select id="ambientProfile">
<option selected="" value="auto">Auto</option>
<option value="city">City</option>
<option value="ocean">Ocean</option>
<option value="market">Market</option>
<option value="nature">Nature</option>
<option value="off">Off</option>
</select>
<input id="ambientVol" max="0.25" min="0" step="0.01" style="width:180px" type="range" value="0.09"/>
<span class="pill" id="ambientPill" style="box-shadow:none">vol: 0.09</span>
</div>
</div>
<div class="field">
<div class="label">Memories</div>
<div class="small" style="margin-bottom:10px">Save moments locally on this device.</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<button id="btnOpenMemories">View memories</button>
<button class="secondary" id="btnClearMemories">Clear</button>
<button class="secondary" id="btnSouvenirPdf">Souvenir PDF</button>
<span class="pill" id="memPill" style="box-shadow:none">0 saved</span>
</div>
<div class="small" style="margin-top:10px">Tip: tap ★ Save moment on any stop.</div>
</div>
<button id="btnDoneSettings" class="secondary">Close</button>
</div>
</div>
</div>
<div aria-live="polite" class="toast" id="toast" role="status"><span id="toastMsg"></span><button class="secondary" id="toastBtn" style="display:none;margin-left:10px;border-radius:999px;padding:6px 10px">Action</button></div>
<div class="arrivalCard" id="arrivalCard">
<div class="arrivalInner">
<h2 id="arrivalTitle"></h2>
<p id="arrivalLine"></p>
</div>
</div>
<div class="arrivalCard" id="completionCard">
<div class="arrivalInner">
<h2>Walk complete</h2>
<p id="completionStats"></p>
<p class="subtle">Every place has a story.</p>
</div>
</div>
<div aria-hidden="true" class="arrivalCard" id="memoriesModal">
<div class="arrivalInner" style="text-align:left;max-width:720px">
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
<h2 style="margin:0">Memories</h2>
<button class="secondary" id="btnCloseMemories" style="border-radius:999px;padding:8px 12px">✕</button>
</div>
<div id="memoriesList" style="display:grid;gap:10px"></div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;align-items:center">
<button id="btnSouvenirPdf">Souvenir PDF</button>
<button class="secondary" id="btnExportMemories">Copy export</button>
<span class="pill" id="memExportPill" style="box-shadow:none"></span>
</div>
</div>
</div>
</body>
</html>
